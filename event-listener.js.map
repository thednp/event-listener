{"version":3,"file":"event-listener.js","names":["registry: EventsRegistry","on: typeof addListener","off: typeof removeListener"],"sources":["package.json","src/index.ts"],"sourcesContent":["","/**\n * Advanced event listener based on subscribe / publish pattern.\n *\n * @see https://www.patterns.dev/posts/classic-design-patterns/#observerpatternjavascript\n * @see https://gist.github.com/shystruk/d16c0ee7ac7d194da9644e5d740c8338#file-subpub-js\n * @see https://hackernoon.com/do-you-still-register-window-event-listeners-in-each-component-react-in-example-31a4b1f6f1c8\n */\nimport { version } from \"../package.json\";\n\nimport {\n  AnimationEvent,\n  AnimationEventHandler,\n  ChangeEvent,\n  ChangeEventHandler,\n  ClipboardEvent,\n  ClipboardEventHandler,\n  CompositionEvent,\n  CompositionEventHandler,\n  DragEvent,\n  DragEventHandler,\n  EventRegistryEntry,\n  EventsRegistry,\n  FocusEvent,\n  FocusEventHandler,\n  FormEvent,\n  FormEventHandler,\n  KeyboardEvent,\n  KeyboardEventHandler,\n  MouseEvent,\n  MouseEventHandler,\n  NativeEvent,\n  NativeEventHandler,\n  PointerEvent,\n  PointerEventHandler,\n  PossibleEventTarget,\n  TouchEvent,\n  TouchEventHandler,\n  TransitionEvent,\n  TransitionEventHandler,\n  UIEvent,\n  UIEventHandler,\n  WheelEvent,\n  WheelEventHandler,\n} from \"./types.ts\";\n\nconst registry: EventsRegistry = {};\n\n/**\n * The global event listener.\n *\n * @see https://developer.mozilla.org/en-US/docs/Web/API/Event/currentTarget\n */\nconst globalListener = (e: NativeEvent) => {\n  const { type, currentTarget } = e;\n\n  registry[type].forEach((listenersMap, element) => {\n    /* istanbul ignore else @preserve */\n    if (currentTarget === element) {\n      listenersMap.forEach((options, listener) => {\n        listener.apply(element, [e]);\n\n        if (typeof options === \"object\" && options.once) {\n          removeListener(element, type, listener, options);\n        }\n      });\n    }\n  });\n};\n\n/**\n * Register a new listener with its options and attach the `globalListener`\n * to the target if this is the first listener.\n */\nconst addListener = <T extends PossibleEventTarget, L = EventListener>(\n  element: T,\n  eventType: string,\n  listener: L,\n  options?: AddEventListenerOptions,\n): void => {\n  // get element listeners first\n  /* istanbul ignore else @preserve */\n  if (!registry[eventType]) {\n    registry[eventType] = new Map();\n  }\n  const oneEventMap = registry[eventType];\n\n  /* istanbul ignore else @preserve */\n  if (!oneEventMap.has(element)) {\n    oneEventMap.set(element, new Map());\n  }\n  const oneElementMap = oneEventMap.get(element) as EventRegistryEntry<T, L>;\n\n  // get listeners size\n  const { size } = oneElementMap;\n\n  // register listener with its options\n  oneElementMap.set(listener, options);\n\n  // add listener last\n  /* istanbul ignore else @preserve */\n  if (!size) {\n    element.addEventListener(\n      eventType,\n      globalListener as unknown as EventListener,\n      options,\n    );\n  }\n};\n\n/**\n * Remove a listener from registry and detach the `globalListener`\n * if no listeners are found in the registry.\n */\nconst removeListener = <T extends PossibleEventTarget, L = EventListener>(\n  element: T,\n  eventType: string,\n  listener: L,\n  options?: AddEventListenerOptions,\n): void => {\n  // get listener first\n  const oneEventMap = registry[eventType];\n  const oneElementMap =\n    oneEventMap && (oneEventMap.get(element) as EventRegistryEntry<T>);\n  const savedOptions =\n    oneElementMap &&\n    oneElementMap.get(listener as NativeEventHandler<typeof element>);\n\n  // also recover initial options\n  const eventOptions = savedOptions !== undefined ? savedOptions : options;\n\n  // unsubscribe second, remove from registry\n  /* istanbul ignore else @preserve */\n  if (\n    oneElementMap &&\n    oneElementMap.has(listener as NativeEventHandler<typeof element>)\n  ) {\n    oneElementMap.delete(listener as NativeEventHandler<typeof element>);\n  }\n  /* istanbul ignore else @preserve */\n  if (oneEventMap && (!oneElementMap || !oneElementMap.size)) {\n    oneEventMap.delete(element);\n  }\n  /* istanbul ignore else @preserve */\n  if (!oneEventMap || !oneEventMap.size) delete registry[eventType];\n\n  // remove listener last\n  /* istanbul ignore else @preserve */\n  if (!oneElementMap || !oneElementMap.size) {\n    element.removeEventListener(\n      eventType,\n      globalListener as unknown as EventListener,\n      eventOptions,\n    );\n  }\n};\n\n// alias main methods\nconst on: typeof addListener = addListener;\nconst off: typeof removeListener = removeListener;\n\nexport {\n  addListener,\n  globalListener,\n  off,\n  on,\n  registry,\n  removeListener,\n  version,\n};\nexport type {\n  AnimationEvent,\n  AnimationEventHandler,\n  ChangeEvent,\n  ChangeEventHandler,\n  ClipboardEvent,\n  ClipboardEventHandler,\n  CompositionEvent,\n  CompositionEventHandler,\n  DragEvent,\n  DragEventHandler,\n  EventRegistryEntry,\n  EventsRegistry,\n  FocusEvent,\n  FocusEventHandler,\n  FormEvent,\n  FormEventHandler,\n  KeyboardEvent,\n  KeyboardEventHandler,\n  MouseEvent,\n  MouseEventHandler,\n  NativeEvent,\n  NativeEventHandler,\n  PointerEvent,\n  PointerEventHandler,\n  PossibleEventTarget,\n  TouchEvent,\n  TouchEventHandler,\n  TransitionEvent,\n  TransitionEventHandler,\n  UIEvent,\n  UIEventHandler,\n  WheelEvent,\n  WheelEventHandler,\n};\n"],"mappings":";;;;;;;;;;;;;;;CC6CA,MAAMA,WAA2B,EAAE;;;;;;CAOnC,MAAM,kBAAkB,MAAmB;EACzC,MAAM,EAAE,MAAM,kBAAkB;AAEhC,WAAS,MAAM,SAAS,cAAc,YAAY;;AAEhD,OAAI,kBAAkB,QACpB,cAAa,SAAS,SAAS,aAAa;AAC1C,aAAS,MAAM,SAAS,CAAC,EAAE,CAAC;AAE5B,QAAI,OAAO,YAAY,YAAY,QAAQ,KACzC,gBAAe,SAAS,MAAM,UAAU,QAAQ;KAElD;IAEJ;;;;;;CAOJ,MAAM,eACJ,SACA,WACA,UACA,YACS;;AAGT,MAAI,CAAC,SAAS,WACZ,UAAS,6BAAa,IAAI,KAAK;EAEjC,MAAM,cAAc,SAAS;;AAG7B,MAAI,CAAC,YAAY,IAAI,QAAQ,CAC3B,aAAY,IAAI,yBAAS,IAAI,KAAK,CAAC;EAErC,MAAM,gBAAgB,YAAY,IAAI,QAAQ;EAG9C,MAAM,EAAE,SAAS;AAGjB,gBAAc,IAAI,UAAU,QAAQ;;AAIpC,MAAI,CAAC,KACH,SAAQ,iBACN,WACA,gBACA,QACD;;;;;;CAQL,MAAM,kBACJ,SACA,WACA,UACA,YACS;EAET,MAAM,cAAc,SAAS;EAC7B,MAAM,gBACJ,eAAgB,YAAY,IAAI,QAAQ;EAC1C,MAAM,eACJ,iBACA,cAAc,IAAI,SAA+C;EAGnE,MAAM,eAAe,iBAAiB,SAAY,eAAe;;AAIjE,MACE,iBACA,cAAc,IAAI,SAA+C,CAEjE,eAAc,OAAO,SAA+C;;AAGtE,MAAI,gBAAgB,CAAC,iBAAiB,CAAC,cAAc,MACnD,aAAY,OAAO,QAAQ;;AAG7B,MAAI,CAAC,eAAe,CAAC,YAAY,KAAM,QAAO,SAAS;;AAIvD,MAAI,CAAC,iBAAiB,CAAC,cAAc,KACnC,SAAQ,oBACN,WACA,gBACA,aACD;;CAKL,MAAMC,KAAyB;CAC/B,MAAMC,MAA6B"}